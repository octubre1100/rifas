<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rifa IVT</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, sans-serif;
        max-width: 850px;
        margin: 20px auto;
        padding: 0 15px;
        background: #f5f6fa;
        color: #333;
      }

      h1,
      h2 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 15px;
      }

      p {
        text-align: center;
        line-height: 1.5;
      }

      button {
        background: #3498db;
        color: white;
        border: none;
        padding: 10px 16px;
        margin: 8px 0;
        cursor: pointer;
        border-radius: 6px;
        font-size: 14px;
        transition: background 0.2s, transform 0.1s;
        display: inline-block;
      }
      button:hover {
        background: #2980b9;
        transform: scale(1.03);
      }

      input {
        padding: 10px;
        margin: 6px 0 14px 0;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: 100%;
        box-sizing: border-box;
        font-size: 14px;
        transition: border 0.2s;
      }
      input:focus {
        border: 1px solid #3498db;
        outline: none;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        background: white;
        border-radius: 6px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      th,
      td {
        padding: 10px;
        text-align: left;
      }
      thead {
        background: #34495e;
        color: white;
      }
      tbody tr:nth-child(even) {
        background: #f9f9f9;
      }
      tbody tr:hover {
        background: #eef6fc;
      }

      #loginPanel,
      #formRegistro {
        background: white;
        border-radius: 6px;
        padding: 16px;
        margin: 15px 0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      #msg {
        margin-top: 10px;
        padding: 12px;
        border-radius: 6px;
        font-weight: bold;
        display: none;
        text-align: center;
      }
      #msg.ok {
        background: #d4edda;
        color: #155724;
      }
      #msg.error {
        background: #f8d7da;
        color: #721c24;
      }
      .card {
        background: white;
        border-radius: 6px;
        padding: 18px;
        margin: 20px 0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .card h2 {
        color: #2c3e50;
        margin-bottom: 10px;
      }

      .card h3 {
        margin-top: 15px;
        color: #34495e;
      }

      .grid-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 10px;
        margin-top: 10px;
      }
      .grid-list ul {
        background: #f9f9f9;
        padding: 10px 14px;
        border-radius: 6px;
        list-style-type: "‚úî ";
      }
      .grid-list li {
        margin: 5px 0;
      }
    </style>
  </head>
  <body>
    <h1>üéüÔ∏è Rifa IVT 5¬∞</h1>

    <button id="btnShowLogin" style="display: none">
      üîë Ingresar token para registrar y ver contactos
    </button>

    <div id="loginPanel" style="display: none">
      <label for="tokenInput">Token:</label>
      <input
        type="password"
        id="tokenInput"
        placeholder="Escribe tu token aqu√≠"
      />
      <button id="btnLogin" style="display: none">Validar token</button>
    </div>

    <div class="card">
      <h2>üéØ Objetivo de la rifa</h2>
      <p>
        Esta rifa tiene como finalidad financiar el
        <strong>viaje educativo 2026</strong> de los estudiantes de
        <strong>5¬∞ a√±o del Instituto Visi√≥n Tecnol√≥gica</strong>. Adem√°s,
        fomenta el trabajo en equipo y la organizaci√≥n entre los alumnos.
      </p>
    </div>

    <!-- Secci√≥n premios -->
    <div class="card">
      <h2>üèÜ Premios</h2>
      <p>Se preparar√°n dos canastas como premio para los ganadores:</p>
      <ul>
        <li><strong>Canasta 1:</strong> alimentos y productos de higiene.</li>
        <li><strong>Canasta 2:</strong> productos de higiene.</li>
      </ul>

      <h3>Contenido principal de las canastas:</h3>
      <div class="grid-list">
        <ul>
          <li>Harina</li>
          <li>Arroz</li>
          <li>Fideos / Pastas</li>
          <li>Az√∫car</li>
          <li>Aceite</li>
          <li>Leche en polvo</li>
          <li>Yerba o t√©</li>
          <li>Conservas (at√∫n, tomate, arvejas)</li>
        </ul>
        <ul>
          <li>Jab√≥n de tocador</li>
          <li>Shampoo</li>
          <li>Papel higi√©nico</li>
          <li>Pasta dental</li>
          <li>Detergente</li>
          <li>Lavandina</li>
          <li>Jab√≥n para ropa</li>
          <li>Esponjas y trapos</li>
        </ul>
      </div>
    </div>

    <!-- Secci√≥n sorteo -->
    <div class="card">
      <h2>üìÖ Sorteo</h2>
      <p>
        El sorteo se realizar√° el <strong>10 de septiembre de 2025</strong>, de
        acuerdo con la <strong>Quiniela Vespertina Nacional</strong>.
      </p>
      <p>
        Los premios ser√°n entregados durante la
        <strong>segunda semana de septiembre</strong>, contactando directamente
        a los ganadores.
      </p>
    </div>

    <!-- Secci√≥n compra -->
    <div class="card">
      <h2>üíµ C√≥mo participar</h2>
      <p>
        2 n√∫meros tienen un valor de <strong>$3.500</strong>. Para adquirirlo,
        puede:
      </p>
      <ul>
        <li>
          Enviar su nombre y los n√∫meros deseados al correo:
          <strong>48910735@ivt.edu.ar</strong>.
        </li>
        <li>O comunicarse directamente con un alumno de 5¬∞ a√±o.</li>
      </ul>
    </div>
    <h2>
      üìä Disponibilidad de n√∫meros
      <button id="toggleDisponibilidad" style="float: right">‚ûï Mostrar</button>
    </h2>
    <div id="tablaDisponibilidad" style="display: none"></div>

    <!-- Pantalla de carga -->
    <div id="loader">
      <div class="spinner"></div>
      <p>Cargando datos de la rifa...</p>
    </div>

    <style>
      /* Loader */
      #loader {
        position: fixed;
        inset: 0;
        background: #f5f6fa;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        z-index: 9999;
        font-size: 18px;
        color: #2c3e50;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 6px solid #ccc;
        border-top: 6px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 12px;
      }
      @keyframes spin {
        100% {
          transform: rotate(360deg);
        }
      }

      /* Grid de n√∫meros */
      .grid-numeros {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
        gap: 6px;
        margin-top: 15px;
      }
      .num {
        padding: 8px;
        border-radius: 6px;
        text-align: center;
        font-weight: bold;
        cursor: default;
        transition: transform 0.2s;
      }
      .num:hover {
        transform: scale(1.1);
      }
      .num.disponible {
        background: #d4edda;
        color: #155724;
      }
      .num.ocupado {
        background: #f8d7da;
        color: #721c24;
        text-decoration: line-through;
      }
    </style>

    <h2>Lista de n√∫meros vendidos</h2>
    <table id="tablaPublica">
      <thead>
        <tr>
          <th>N√∫mero</th>
          <th>Nombre</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="formRegistro" style="display: none">
      <h2>Registro de n√∫mero</h2>
      <label for="numero">N√∫mero:</label>
      <input type="number" id="numero" min="1" placeholder="Ej. 15" />

      <label for="nombre">Nombre:</label>
      <input type="text" id="nombre" placeholder="Ej. Juan P√©rez" />

      <label for="contacto">Contacto:</label>
      <input type="text" id="contacto" placeholder="Tel√©fono o email" />

      <button id="btnRegistrar">Registrar</button>

      <h2>Lista completa (con contactos)</h2>
      <table id="tablaCompleta">
        <thead>
          <tr>
            <th>N√∫mero</th>
            <th>Nombre</th>
            <th>Contacto</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="msg"></div>
    <script>
      // URL de tu GAS
      const API_URL =
        "https://script.google.com/macros/s/AKfycbw3W_PHusBJhuUvopjdeCMtaWF5gAgJ2b4Cgsuf8Lfrxeod7dGaW90WXPE325oeqEey/exec";

      // Token definido en el front-end
      const FRONTEND_TOKEN = "rifaivt5";

      let token = sessionStorage.getItem("token") || null;

      const $ = (s) => document.querySelector(s);
      const tablaPublicaBody = $("#tablaPublica tbody");
      const tablaCompletaBody = $("#tablaCompleta tbody");
      const msgBox = $("#msg");
      const loginPanel = $("#loginPanel");
      const formRegistro = $("#formRegistro");
      const btnShowLogin = $("#btnShowLogin");

      async function fetchPublic() {
        try {
          const res = await fetch(API_URL);
          const json = await res.json();
          if (!json.ok) throw new Error(json.error || "Error al cargar datos");
          renderPublic(json.data);
        } catch (e) {
          showMsg(e.message, true);
        }
      }

      async function fetchPrivado() {
        try {
          const res = await fetch(API_URL);
          const json = await res.json();
          if (!json.ok) throw new Error(json.error || "Error al cargar datos");
          renderPrivado(json.data);
        } catch (e) {
          showMsg(e.message, true);
        }
      }

      function renderPublic(data) {
        tablaPublicaBody.innerHTML = "";
        data.forEach(({ numero, nombre }) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${numero}</td><td>${nombre}</td>`;
          tablaPublicaBody.appendChild(tr);
        });
      }

      function renderPrivado(data) {
        tablaCompletaBody.innerHTML = "";
        data.forEach(({ numero, nombre, contacto, fecha }) => {
          const fechaStr = fecha ? new Date(fecha).toLocaleString() : "";
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${numero}</td><td>${nombre}</td><td>${contacto}</td><td>${fechaStr}</td>`;
          tablaCompletaBody.appendChild(tr);
        });
      }

      function showMsg(text, isError = false) {
        msgBox.textContent = text;
        msgBox.className = isError ? "error" : "ok";
        msgBox.style.display = "block";
        setTimeout(() => (msgBox.style.display = "none"), 3500);
      }

      async function registrar() {
        if (!token) {
          showMsg("Debes validar el token primero.", true);
          return;
        }

        const numero = $("#numero").value.trim();
        const nombre = $("#nombre").value.trim();
        const contacto = $("#contacto").value.trim();
        if (!numero || !nombre) {
          showMsg("N√∫mero y nombre son obligatorios.", true);
          return;
        }

        try {
          const res = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({ numero, nombre, contacto, token }),
          });
          const json = await res.json();
          if (!json.ok) {
            showMsg(json.error || "Error al registrar", true);
            return;
          }
          showMsg("Registro exitoso.");
          cargarPrivado();
          cargarPublico();
          $("#numero").value = "";
          $("#nombre").value = "";
          $("#contacto").value = "";
        } catch (e) {
          showMsg("Error de red.", true);
        }
      }

      function logout() {
        token = null;
        sessionStorage.removeItem("token");
        formRegistro.style.display = "none";
        loginPanel.style.display = "none";
        btnShowLogin.style.display = "inline-block";
        cargarPublico();
      }

      function login() {
        loginPanel.style.display = "block";
        btnShowLogin.style.display = "none";
        $("#tokenInput").value = "";
        $("#tokenInput").focus();
      }

      function validarToken() {
        const t = $("#tokenInput").value.trim();
        if (!t) {
          showMsg("Ingres√° el token.", true);
          return;
        }

        if (t !== FRONTEND_TOKEN) {
          showMsg("Token inv√°lido", true);
          return;
        }

        token = t;
        sessionStorage.setItem("token", token);
        showMsg("Token v√°lido. Acceso concedido.");
        loginPanel.style.display = "none";
        formRegistro.style.display = "block";
        cargarPrivado();
      }

      async function cargarPublico() {
        await fetchPublic();
      }
      async function cargarPrivado() {
        await fetchPrivado();
      }

      btnShowLogin.addEventListener("click", login);
      $("#btnLogin").addEventListener("click", validarToken);
      $("#btnRegistrar").addEventListener("click", registrar);

      window.addEventListener("DOMContentLoaded", () => {
        cargarPublico();
        if (token) {
          formRegistro.style.display = "block";
          btnShowLogin.style.display = "none";
          cargarPrivado();
        }
      });
      const TOTAL_NUMEROS = 1000; // üîπ Ajusta aqu√≠ el total de la rifa
      const tablaDisp = document.getElementById("tablaDisponibilidad");
      const toggleBtn = document.getElementById("toggleDisponibilidad");
      const loader = document.getElementById("loader");

      async function renderDisponibilidad() {
        try {
          const res = await fetch(API_URL);
          const json = await res.json();
          if (!json.ok) throw new Error(json.error || "Error al cargar");

          const ocupados = json.data.map((d) => parseInt(d.numero, 10));
          tablaDisp.innerHTML = "";
          const grid = document.createElement("div");
          grid.className = "grid-numeros";

          for (let i = 1; i <= TOTAL_NUMEROS; i++) {
            const div = document.createElement("div");
            div.classList.add("num");
            div.textContent = i;
            if (ocupados.includes(i)) {
              div.classList.add("ocupado");
            } else {
              div.classList.add("disponible");
            }
            grid.appendChild(div);
          }
          tablaDisp.appendChild(grid);
        } catch (e) {
          console.error(e);
          tablaDisp.textContent = "Error al cargar disponibilidad";
        }
      }

      // üîπ Toggle minimizar/maximizar
      toggleBtn.addEventListener("click", () => {
        if (tablaDisp.style.display === "none") {
          tablaDisp.style.display = "block";
          toggleBtn.textContent = "‚ûñ Ocultar";
        } else {
          tablaDisp.style.display = "none";
          toggleBtn.textContent = "‚ûï Mostrar";
        }
      });

      async function iniciarPagina() {
        // Cargar ambas tablas antes de mostrar la p√°gina
        try {
          await Promise.all([fetchPublic(), renderDisponibilidad()]);
        } catch (e) {
          console.error("Error inicial:", e);
        } finally {
          loader.style.display = "none"; // quitar loader
          document.body.style.overflow = "auto"; // habilitar scroll
        }
      }

      // üîπ Bloquea la p√°gina hasta cargar
      document.body.style.overflow = "hidden";
      window.addEventListener("DOMContentLoaded", iniciarPagina);
    </script>
  </body>
</html>
